(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{298:function(e,t,a){"use strict";var n=a(0),r=a(7),o={getChatRooms:function(){var e={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token}};return fetch("/api/chat/getChatRooms/",e).then(i).then(function(e){return e})},getMessagesForRoom:function(e){var t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify(Object(n.a)({},e))};return fetch("/api/chat/getMessagesForRoom/",t).then(i).then(function(e){return e})},sendMessage:function(e){var t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify(Object(n.a)({},e))};return fetch("/api/chat/sendMessage/",t).then(i).then(function(e){return e})},sendImage:function(e){var t={method:"POST",headers:{Authorization:JSON.parse(localStorage.getItem("user")).token},body:e};return fetch("/api/chat/sendImage/",t).then(i).then(function(e){return e})},readMessages:function(e){var t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify(Object(n.a)({},e))};return fetch("/api/chat/readMessages/",t).then(i).then(function(e){return e})},call:function(e){var t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify(Object(n.a)({},e))};return fetch("/api/chat/call/",t).then(i).then(function(e){return e})},answer:function(e){var t={method:"POST",headers:{"Content-Type":"application/json",Authorization:JSON.parse(localStorage.getItem("user")).token},body:JSON.stringify(Object(n.a)({},e))};return fetch("/api/chat/answer/",t).then(i).then(function(e){return e})}};function i(e){return e.text().then(function(t){var a=t&&JSON.parse(t);if(!e.ok){401===e.status&&(localStorage.removeItem("user"),window.location.reload(!0));var n=a&&a.message||e.statusText;return Promise.reject(n)}return a})}a.d(t,"a",function(){return s});var s={typing:function(e){return function(t){t({type:r.a.TYPING,roomId:e})}},stoppedTyping:function(e){return function(t){t({type:r.a.STOPPED_TYPING,roomId:e})}},changeRoom:function(e){return function(t){t({type:r.a.CHANGE_ROOM,room:e})}},getChatRooms:function(){return function(e){e({type:r.a.GET_ROOMS_REQUEST}),o.getChatRooms().then(function(t){var a;e((a=t.rooms,{type:r.a.GET_ROOMS_SUCCESS,rooms:a})),t.rooms.forEach(function(t){return e((a=t._id,{type:r.a.INIT_MESSAGE_ARRAY,roomId:a}));var a})},function(e){console.log(e)})}},getMessagesForRoom:function(e){return function(t){var a;e.initialFetch?t((a=e._id,{type:r.a.GET_MESSAGES_INITIAL_REQUEST,roomId:a})):t(function(e){return{type:r.a.GET_MESSAGES_REQUEST,roomId:e}}(e._id)),o.getMessagesForRoom(e).then(function(a){var n;t((n={messages:a.messages.reverse(),roomId:e._id},{type:r.a.GET_MESSAGES_SUCCESS,data:n}))},function(e){console.log(e)})}},sendMessage:function(e){return function(t){t(function(e){return{type:r.a.SEND_MESSAGE_REQUEST,message:e}}(Object(n.a)({},e,{sent:!1}))),o.sendMessage(e).then(function(e){var a;t((a=e.message,{type:r.a.SEND_MESSAGE_SUCCESS,message:a}))},function(e){console.log(e)})}},sendImage:function(e,t){return function(a){a(function(e){return{type:r.a.SEND_MESSAGE_REQUEST,message:e}}(Object(n.a)({},t,{sent:!1}))),o.sendImage(e).then(function(e){var t;a((t=e.message,{type:r.a.SEND_MESSAGE_SUCCESS,message:t}))},function(e){console.log(e)})}},newMessage:function(e){return function(t){t(function(e){return{type:r.a.NEW_MESSAGE,message:e}}(e)),t({type:r.a.INC_MESSAGE_COUNT})}},readMessages:function(e){var t=e.messageIds,a=e.roomId;return function(n){n(function(e,t){return{type:r.a.READ_MESSAGES,messageIds:e,roomId:t}}(t,a)),o.readMessages(e).then(function(){},function(e){console.log(e)})}},changeActivityStatus:function(e){return function(t){t({type:r.a.CHANGE_ACTIVITY_STATUS,user:e})}},imageMessageRequest:function(e){return function(t){t(function(e){return{type:r.a.NEW_IMAGE_MESSAGE_REQUEST,message:e}}(e))}},call:function(e){return function(t){t({type:r.a.OPEN_CALLING_MODAL}),o.call(e).then(function(){},function(e){console.log(e)})}},answer:function(e){return function(t){o.answer(e).then(function(){},function(e){console.log(e)})}},endCall:function(){return function(e){e({type:r.a.CLOSE_CALLING_MODAL})}},endAnsweringCall:function(){return function(e){e({type:r.a.CLOSE_ANSWERING_MODAL})}},searchUsers:function(e){return function(t){t({type:r.a.SEARCH_USERS,rooms:e})}}}},302:function(e,t,a){"use strict";function n(e,t){console.log(e);for(var a=e.split(","),n=a[0].match(/:(.*?);/)[1],r=atob(a[1]),o=r.length,i=new Uint8Array(o);o--;)i[o]=r.charCodeAt(o);return new File([i],t,{type:n})}function r(e){return e.substring("data:image/".length,e.indexOf(";base64"))}function o(e,t,a){var n=e;n.width=a.width,n.height=a.height;var r=n.getContext("2d"),o=new Image;o.src=t,o.onload=function(){r.drawImage(o,a.x,a.y,a.width,a.height,0,0,a.width,a.height)}}a.d(t,"a",function(){return n}),a.d(t,"b",function(){return r}),a.d(t,"c",function(){return o})},404:function(e,t,a){"use strict";a.d(t,"a",function(){return o});var n=a(24),r=a(25),o=function(){function e(){Object(n.a)(this,e),this.stream=null}return Object(r.a)(e,[{key:"getPremissions",value:function(){var e=this;return new Promise(function(t,a){navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(function(a){e.stream=a,t(a)}).catch(function(e){throw new Error("Unable to fetch stream "+e)})})}},{key:"stopRecoring",value:function(){this.stream.getTracks().forEach(function(e){e.stop()})}}]),e}()},426:function(e,t){},428:function(e,t){},819:function(e,t,a){"use strict";a.r(t);var n=a(24),r=a(25),o=a(27),i=a(26),s=a(28),c=a(1),l=a.n(c),u=a(18),m=a(0),d=a(298),f=function(e){function t(){var e,a;Object(n.a)(this,t);for(var r=arguments.length,s=new Array(r),c=0;c<r;c++)s[c]=arguments[c];return(a=Object(o.a)(this,(e=Object(i.a)(t)).call.apply(e,[this].concat(s)))).componentDidMount=function(){(0,a.props.dispatch)(d.a.getChatRooms())},a.changeRoom=function(e){(0,a.props.dispatch)(d.a.changeRoom(e))},a.handleSearch=function(e){var t=a.props,n=t.dispatch,r=t.rooms,o=t.user.data,i=r.filter(function(t){var a=t.members.filter(function(e){return e._id!==o._id});return a[0].firstName.toLocaleLowerCase().includes(e.target.value.toLocaleLowerCase())||a[0].lastName.toLocaleLowerCase().includes(e.target.value.toLocaleLowerCase())?t:null});n(d.a.searchUsers(i))},a}return Object(s.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this,t=this.props,a=t.user,n=t.rooms,r=t.searchedRooms,o=t.roomId,i=(r||n).map(function(t){var n=t.members.filter(function(e){return e._id!==a.data._id}),r="...";return t.lastMessage[0]&&t.lastMessage[0].sender===a.data._id?r="text"===t.lastMessage[0].messageType?"You: "+t.lastMessage[0].text:"You sent image ":t.lastMessage[0]&&(r="text"===t.lastMessage[0].messageType?t.lastMessage[0].text:"Image "),l.a.createElement("li",{className:t._id===o?"contact active":"contact",key:t._id,onClick:function(){return e.changeRoom(Object(m.a)({},t,{user:Object(m.a)({},n[0])}))}},l.a.createElement("div",{className:"wrap"},l.a.createElement("span",{className:"contact-status ".concat(n[0].activityStatus)}),l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(n[0].profilePicture),alt:""}),l.a.createElement("div",{className:"meta"},l.a.createElement("p",{className:"name"},n[0].firstName+" "+n[0].lastName),l.a.createElement("p",{className:"preview"},r))))});return l.a.createElement("div",{id:"sidepanel"},l.a.createElement("div",{id:"profile"},l.a.createElement("div",{className:"wrap"},l.a.createElement("img",{id:"profile-img",src:"/images/profile-picture/100x100/".concat(a.data.profilePicture),className:"online",alt:""}),l.a.createElement("p",null,a.data.firstName+" "+a.data.lastName),l.a.createElement("i",{className:"fa fa-chevron-down expand-button","aria-hidden":"true"}),l.a.createElement("div",{id:"status-options"},l.a.createElement("ul",null,l.a.createElement("li",{id:"status-online",className:"active"},l.a.createElement("span",{className:"status-circle"}),l.a.createElement("p",null,"Online")),l.a.createElement("li",{id:"status-offline"},l.a.createElement("span",{className:"status-circle"}),l.a.createElement("p",null,"Offline")))))),l.a.createElement("div",{id:"search"},l.a.createElement("label",{htmlFor:""},l.a.createElement("i",{className:"fa fa-search","aria-hidden":"true"})),l.a.createElement("input",{type:"text",placeholder:"Search contacts...",onChange:this.handleSearch})),l.a.createElement("div",{id:"contacts"},l.a.createElement("ul",null,i.length?i:"No users")),l.a.createElement("div",{id:"bottom-bar"},l.a.createElement("button",{id:"addcontact"},l.a.createElement("i",{className:"fa fa-user-plus fa-fw","aria-hidden":"true"}),l.a.createElement("span",null,"Add contact")),l.a.createElement("button",{id:"settings"},l.a.createElement("i",{className:"fa fa-cog fa-fw","aria-hidden":"true"}),l.a.createElement("span",null,"Settings"))))}}]),t}(c.Component),p=Object(u.b)(function(e){return{user:e.user,rooms:e.chat.rooms,searchedRooms:e.chat.searchedRooms,roomId:e.chat.roomId}})(f),g=(a(394),a(790)),h=a(380),E=a.n(h),v=a(124),S=a(31),y=a(302),b=10485760,O="image/x-png, image/png, image/jpg, image/jpeg, image/gif",I=O.split(",").map(function(e){return e.trim()}),N=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(o.a)(this,Object(i.a)(t).call(this))).sendTypingStatus=function(){var t=e.props,a=t.socket,n=t.chat,r=n.roomId,o=n.currentRoom;a.emit("typing",{roomId:r,userId:o.user._id})},e.handleChange=function(t){var a=e.props,n=a.socket,r=a.chat,o=r.roomId,i=r.currentRoom;e.debouncedTyping(),clearTimeout(e.timer),e.setState({value:t.target.value}),e.timer=setTimeout(function(){n.emit("stoppedTyping",{roomId:o,userId:i.user._id})},3e3)},e.addEmoji=function(t){var a=t.native;e.setState({value:e.state.value+a})},e.handleSubmit=function(t){t.preventDefault();var a=e.props,n=a.dispatch,r=a.chat,o=r.roomId,i=r.currentRoom,s=a.userId,c=e.state.value;""!==c&&n(d.a.sendMessage({receiver:i.user,value:c,roomId:o,sender:s,uuid:E()()})),e.setState({value:""})},e.toggleEmojiPicker=function(){e.setState({showPicker:!e.state.showPicker})},e.handleFileSelect=function(t){var a=e.props,n=a.dispatch,r=a.chat,o=r.roomId,i=r.currentRoom,s=a.userId,c=t.target.files;if(c&&c.length>0&&e.verifyFile(c)){var l=c[0],u=new FileReader;u.addEventListener("load",function(){var e=u.result,t="image."+Object(y.b)(e),a=Object(y.a)(e,t),r=new FormData,c=E()();r.append("receiver",JSON.stringify(i.user)),r.append("roomId",o),r.append("uuid",c),r.append("photo",a,a.name),n(d.a.sendImage(r,{receiver:i.user,value:"Image",sender:s,roomId:o,uuid:c}))},!1),u.readAsDataURL(l)}},e.verifyFile=function(t){if(t&&t.length>0){var a=t[0],n=a.type,r=a.size,o=e.props.dispatch;return I.includes(n)?!(r>b)||(o(S.a.error("This file is not allowed. "+r+" bytes is too large")),!1):(o(S.a.error("This file is not allowed. Only images are allowed.")),!1)}},e.state={value:"",showPicker:!1},e.debouncedTyping=Object(v.b)(3e3,e.sendTypingStatus),e}return Object(s.a)(t,e),Object(r.a)(t,[{key:"componentDidMount",value:function(){this.timer=null}},{key:"render",value:function(){var e=this.state.value,t=this.state.showPicker?"grid":"none";return l.a.createElement("div",{className:"message-input"},l.a.createElement("div",{style:{display:t,justifyItems:"end"}},l.a.createElement(g.a,{native:!0,onSelect:this.addEmoji})),l.a.createElement("div",{className:"wrap"},l.a.createElement("form",{onSubmit:this.handleSubmit},l.a.createElement("input",{onChange:this.handleChange,value:e,type:"text",placeholder:"Write your message..."})),l.a.createElement("label",null,l.a.createElement("input",{type:"file",accept:O,multiple:!1,onChange:this.handleFileSelect}),l.a.createElement("i",{className:"fa fa-paperclip","aria-hidden":"true"})),l.a.createElement("button",{onClick:this.toggleEmojiPicker},l.a.createElement("i",{className:"fa fa-smile-o","aria-hidden":"true"}))))}}]),t}(c.Component),w=Object(u.b)(function(e){return{chat:e.chat,socket:e.socket.socket,userId:e.user.data._id}})(N),C=a(825),j=a(367),M=a(792),_=a(535),k=a(821),R=a(320),T=a(404),A=a(405),P=a.n(A),x=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(o.a)(this,Object(i.a)(t).call(this))).handleOpen=function(){var t=e.props,a=t.dispatch,n=t.currentRoom,r=t.roomId,o=t.socket;e.mediaHandler.getPremissions().then(function(t){e.setState({hasMedia:!0}),e.stream=t,e.peer=new P.a({initiator:!0,stream:t,trickle:!1}),e.peer.on("error",function(e){console.log(e)}),e.peer.on("stream",function(t){e.userVideo.srcObject=t,e.userVideo.play()}),o.on("newAnswer",function(t){e.peer.signal(t.webRtc)}),e.peer.on("signal",function(e){a(d.a.call({currentRoom:n,roomId:r,webRtc:e}))}),e.peer.on("close",function(){e.mediaHandler.stopRecoring(),a(d.a.endCall()),e.setState({hasMedia:!1})}),e.myVideo.srcObject=t,e.myVideo.play()}).catch(function(e){return console.log(e)})},e.handleClose=function(){var t=e.props.dispatch;e.peer.destroy(),e.mediaHandler.stopRecoring(),t(d.a.endCall()),e.setState({hasMedia:!1})},e.state={hasMedia:!1},e.stream=null,e.mediaHandler=new T.a,e}return Object(s.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this,t=this.props.callingModal;return l.a.createElement(R.a,{open:t,trigger:l.a.createElement("i",{onClick:this.handleOpen,className:"fa fa-video-camera","aria-hidden":"true"})},l.a.createElement(R.a.Content,null,l.a.createElement("video",{style:{width:300,height:"auto"},ref:function(t){e.myVideo=t}}),l.a.createElement("video",{style:{width:300,height:"auto"},ref:function(t){e.userVideo=t}})),l.a.createElement(R.a.Actions,null,l.a.createElement(k.a,{negative:!0,onClick:this.handleClose},"End call")))}}]),t}(c.Component),G=Object(u.b)(function(e){return{userId:e.user.data._id,profilePicture:e.user.data.profilePicture,callingModal:e.chat.callingModal,socket:e.socket.socket,currentRoom:e.chat.currentRoom,roomId:e.chat.roomId}})(x),F=a(745),D=a(116),L=a.n(D),U=a(118),J=a(119),H=a.n(J),z=a(120),B=a.n(z),V=a(111),Q=a.n(V),W=a(112),Y=a.n(W);Q.a.extend(Y.a),H()(U),B()(U);var q={formatHref:function(e,t){return"hashtag"===t&&(e="/hashtags/"+e.substring(1)),"mention"===t&&(e="/"+e.substring(1)),e},attributes:{target:{url:"_blank"}}},K=function(e){var t=e.message,a=e.userId,n=e.profilePicture,r=e.currentRoom;return t.sender===a?!1===t.sent?l.a.createElement("li",{className:"replies",key:t.uuid},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(n),alt:""}),l.a.createElement("p",{style:{backgroundColor:"#f5f5f5",color:"black",border:"1px solid grey",wordWrap:"break-word"}},l.a.createElement(L.a,{options:q},t.value))):"text"===t.messageType?l.a.createElement("li",{className:"replies"},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(n),alt:""}),l.a.createElement(M.a,{content:Q()(t.createdAt).fromNow()+", seen:"+t.read,trigger:l.a.createElement("p",null,l.a.createElement(L.a,{options:q},t.text))})):l.a.createElement("li",{className:"replies"},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(n),alt:""}),l.a.createElement(M.a,{content:Q()(t.createdAt).fromNow()+", seen:"+t.read,trigger:l.a.createElement("img",{style:{borderRadius:"3%",objectFit:"cover",width:"40%",height:"20%"},src:"/images/chat-images/".concat(t.photo),alt:""})})):!1===t.sent?l.a.createElement("li",{className:"sent",key:t.uuid},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(r.user.profilePicture),alt:""}),l.a.createElement("p",{style:{backgroundColor:"#f5f5f5",color:"black",border:"1px solid grey",wordWrap:"break-word"}},l.a.createElement(L.a,{options:q},t.value))):"text"===t.messageType?l.a.createElement("li",{className:"sent"},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(r.user.profilePicture),alt:""}),l.a.createElement(M.a,{content:Q()(t.createdAt).fromNow()+", seen:"+t.read,trigger:l.a.createElement("p",null," ",l.a.createElement(L.a,{options:q},t.text))})):l.a.createElement("li",{className:"sent"},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(r.user.profilePicture),alt:""}),l.a.createElement(M.a,{content:Q()(t.createdAt).fromNow()+", seen:"+t.read,trigger:l.a.createElement("img",{style:{borderRadius:"3%",objectFit:"cover",width:"40%",height:"20%"},src:"/images/chat-images/".concat(t.photo),alt:""})}))},X=function(e){function t(){var e;return Object(n.a)(this,t),(e=Object(o.a)(this,Object(i.a)(t).call(this))).componentDidMount=function(){var t=e.props,a=t.dispatch,n=t.currentRoom,r=t.roomId,o=t.userId,i=t.content;if(i.messages.length){var s=i.messages.filter(function(e){return e.receiver===o&&!e.read}).map(function(e){return e._id});s.length&&a(d.a.readMessages({messageIds:s,roomId:r}))}else a(d.a.getMessagesForRoom(Object(m.a)({},n,{initialFetch:!0})));e.handleScrollToBottom()},e.componentDidUpdate=function(){var t=e.props,a=t.dispatch,n=t.roomId,r=t.content,o=t.userId,i=r.messages.filter(function(e){return e.receiver===o&&!e.read}).map(function(e){return e._id});i.length&&a(d.a.readMessages({messageIds:i,roomId:n})),e.scrollToBottom()},e.handleScrollToBottom=function(){F.animateScroll.scrollToBottom({containerId:"ContainerElementID",duration:500,delay:0})},e.fetchMessages=function(){var t=e.props,a=t.dispatch,n=t.currentRoom,r=t.content.messages[0]._id;a(d.a.getMessagesForRoom(Object(m.a)({},n,{lastId:r,initialFetch:!1})))},e.messagesContainer=l.a.createRef(),e}return Object(s.a)(t,e),Object(r.a)(t,[{key:"scrollToBottom",value:function(){this.messagesContainer.current.scrollHeight-this.messagesContainer.current.scrollTop-this.messagesContainer.current.clientHeight<350&&F.animateScroll.scrollToBottom({containerId:"ContainerElementID",duration:200,delay:0})}},{key:"render",value:function(){var e=this.props,t=e.currentRoom,a=e.content,n=e.userId,r=e.profilePicture,o=t.messages-a.messages.length,i=a.messages.map(function(e){return l.a.createElement(K,{key:e._id||e.uuid,currentRoom:t,message:e,userId:n,profilePicture:r})});return l.a.createElement("div",{className:"content"},a.initialMessagesFetchig?l.a.createElement(C.a,{active:!0},l.a.createElement(j.a,null)):null,l.a.createElement("div",{className:"contact-profile"},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(t.user.profilePicture),alt:""}),l.a.createElement("p",null,t.user.firstName+" "+t.user.lastName),l.a.createElement("div",{className:"social-media"},l.a.createElement(M.a,{content:"Scroll to bottom.",trigger:l.a.createElement("i",{onClick:this.handleScrollToBottom,className:"fa fa-arrow-down","aria-hidden":"true"})}),l.a.createElement(G,null),l.a.createElement(_.a,{basic:!0,color:"red",pointing:"left"},"This isn't working."))),l.a.createElement("div",{className:"messages",id:"ContainerElementID",ref:this.messagesContainer},o?l.a.createElement(k.a,{fluid:!0,disabled:a.messageFetching,loading:a.messageFetching,onClick:this.fetchMessages},"Load ",t.messages-a.messages.length," more"):null,l.a.createElement("ul",null,i,a.isTyping?l.a.createElement("li",{className:"sent",key:t.user._id},l.a.createElement("img",{src:"/images/profile-picture/100x100/".concat(t.user.profilePicture),alt:""}),l.a.createElement("p",null,"typing...")):null)),l.a.createElement(w,null))}}]),t}(c.Component),Z=Object(u.b)(function(e){return{userId:e.user.data._id,profilePicture:e.user.data.profilePicture,callingModal:e.chat.callingModal,socket:e.socket.socket,currentRoom:e.chat.currentRoom,roomId:e.chat.roomId}})(X);a.d(t,"default",function(){return ee});var $=function(e){function t(){var e,a;Object(n.a)(this,t);for(var r=arguments.length,s=new Array(r),c=0;c<r;c++)s[c]=arguments[c];return(a=Object(o.a)(this,(e=Object(i.a)(t)).call.apply(e,[this].concat(s)))).componentDidMount=function(){document.title="Messages | social-network"},a}return Object(s.a)(t,e),Object(r.a)(t,[{key:"render",value:function(){var e=this.props,t=e.chat,a=e.roomId;return l.a.createElement("div",{id:"frame"},l.a.createElement(p,null),t.currentRoom?l.a.createElement(Z,{content:t[a],key:a}):null)}}]),t}(c.Component),ee=Object(u.b)(function(e){return{roomId:e.chat.roomId,chat:e.chat}})($)}}]);